<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MD Viewer</title>
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<style>
:root {
  --bg:       #0f0f17;
  --bg2:      #16161f;
  --bg3:      #1e1e2e;
  --bg4:      #252535;
  --border:   #2e2e45;
  --accent:   #7c6af7;
  --accent2:  #5b8af7;
  --gold:     #f5c542;
  --green:    #4caf86;
  --red:      #f05555;
  --text:     #e2e2f0;
  --text2:    #9090b8;
  --text3:    #5a5a80;
  --sw:       280px;
  --code-bg:  #1a1a2b;
  --r:        10px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; display: flex; flex-direction: column;
}

/* â”€â”€ TOPBAR â”€â”€ */
#topbar {
  position: fixed; top: 0; left: 0; right: 0; z-index: 200;
  height: 54px; background: var(--bg2);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px; padding: 0 16px;
}
.logo {
  font-size: 17px; font-weight: 800; white-space: nowrap;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
#search-wrap { flex: 1; max-width: 400px; position: relative; }
#search {
  width: 100%; padding: 7px 50px 7px 34px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text); font-size: 14px; outline: none;
  transition: border-color .2s;
}
#search:focus { border-color: var(--accent); }
#search::placeholder { color: var(--text3); }
#search-wrap::before {
  content: 'ğŸ”'; position: absolute; left: 9px; top: 50%;
  transform: translateY(-50%); font-size: 13px; pointer-events: none;
}
#search-count {
  position: absolute; right: 8px; top: 50%;
  transform: translateY(-50%); font-size: 11px; color: var(--text3);
}
.tb-btn {
  padding: 7px 14px; border: none; border-radius: 8px;
  font-size: 13px; font-weight: 600; cursor: pointer;
  transition: opacity .15s, transform .1s; white-space: nowrap;
}
.tb-btn:hover { opacity: .85; transform: translateY(-1px); }
.tb-btn:active { transform: translateY(0); }
#open-btn { background: linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; }
#refresh-btn {
  background: var(--bg3); border: 1px solid var(--border); color: var(--text2);
}
#refresh-btn.active { background: var(--green); border-color: var(--green); color: #fff; }
#theme-btn { background: var(--bg3); border: 1px solid var(--border); color: var(--text2); }
#file-input { display: none; }

#file-badge {
  display: none; max-width: 200px; overflow: hidden; text-overflow: ellipsis;
  white-space: nowrap; padding: 4px 10px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 20px; font-size: 11px; color: var(--text3);
}

/* â”€â”€ PROGRESS â”€â”€ */
#prog-bar {
  position: fixed; top: 54px; left: 0; right: 0; height: 3px; z-index: 199;
}
#prog-fill {
  height: 100%; width: 0%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  transition: width .1s;
}

/* â”€â”€ LAYOUT â”€â”€ */
#layout { display: flex; margin-top: 54px; min-height: calc(100vh - 54px); }

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar {
  position: fixed; top: 54px; left: 0; bottom: 0; width: var(--sw);
  background: var(--bg2); border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  transition: transform .3s; z-index: 90;
}

/* Sidebar tabs */
.sb-tabs {
  display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.sb-tab {
  flex: 1; padding: 10px 0; background: none; border: none;
  font-size: 12px; font-weight: 700; letter-spacing: .8px; text-transform: uppercase;
  color: var(--text3); cursor: pointer; border-bottom: 2px solid transparent;
  transition: all .15s;
}
.sb-tab:hover { color: var(--text2); }
.sb-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.sb-panel { display: none; flex: 1; overflow-y: auto; overflow-x: hidden; }
.sb-panel.active { display: flex; flex-direction: column; }
.sb-panel::-webkit-scrollbar { width: 4px; }
.sb-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* TOC items */
.toc-item {
  display: block; padding: 5px 14px; font-size: 13px; color: var(--text2);
  text-decoration: none; border-left: 3px solid transparent;
  transition: all .12s; cursor: pointer;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.toc-item:hover { color: var(--text); background: var(--bg3); }
.toc-item.active { color: var(--accent); border-left-color: var(--accent); background: rgba(124,106,247,.08); }
.toc-item.h1 { font-weight: 700; font-size: 13px; padding-left: 14px; color: var(--text); margin-top: 4px; }
.toc-item.h2 { padding-left: 22px; font-size: 12.5px; }
.toc-item.h3 { padding-left: 34px; font-size: 12px; color: var(--text3); }
#toc-list { padding: 8px 0; }

/* History items */
#history-panel { padding: 10px 0; }
.hist-empty {
  padding: 30px 16px; text-align: center;
  font-size: 13px; color: var(--text3); line-height: 1.6;
}
.hist-item {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: background .12s; position: relative;
}
.hist-item:hover { background: var(--bg3); }
.hist-item.current-doc { background: rgba(124,106,247,.07); }
.hist-item.current-doc .hist-name { color: var(--accent); }
.hist-icon { font-size: 20px; flex-shrink: 0; }
.hist-info { flex: 1; min-width: 0; }
.hist-name {
  font-size: 13px; font-weight: 600; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.hist-meta { font-size: 11px; color: var(--text3); margin-top: 2px; }
.hist-del {
  opacity: 0; padding: 2px 6px; background: var(--bg4);
  border: 1px solid var(--border); border-radius: 5px;
  color: var(--red); font-size: 11px; cursor: pointer;
  transition: opacity .15s;
}
.hist-item:hover .hist-del { opacity: 1; }
.hist-del:hover { background: var(--red); color: #fff; }

.hist-clear-btn {
  display: block; width: calc(100% - 28px); margin: 10px 14px 0;
  padding: 7px; background: var(--bg3);
  border: 1px solid var(--border); border-radius: 7px;
  color: var(--text3); font-size: 12px; cursor: pointer;
  transition: all .15s;
}
.hist-clear-btn:hover { background: var(--red); border-color: var(--red); color: #fff; }

/* â”€â”€ MAIN â”€â”€ */
#main {
  margin-left: var(--sw); flex: 1;
  padding: 40px 48px 80px; max-width: 960px;
}

/* â”€â”€ DROP ZONE â”€â”€ */
#drop-zone {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; min-height: calc(100vh - 120px);
  text-align: center; gap: 14px;
}
#drop-zone.drag-over { background: rgba(124,106,247,.05); border-radius: 16px; }
.dz-icon { font-size: 64px; }
#drop-zone h2 { font-size: 24px; font-weight: 700; }
#drop-zone p { color: var(--text2); font-size: 14px; max-width: 360px; line-height: 1.7; }
#drop-btn {
  padding: 11px 28px; background: linear-gradient(135deg,var(--accent),var(--accent2));
  border: none; border-radius: 10px; color: #fff; font-size: 15px;
  font-weight: 700; cursor: pointer; transition: transform .15s, opacity .2s;
}
#drop-btn:hover { transform: translateY(-2px); opacity: .9; }
.dz-or { color: var(--text3); font-size: 12px; }

/* â”€â”€ CONTENT â”€â”€ */
#content { display: none; }
#content h1,#content h2,#content h3,
#content h4,#content h5,#content h6 { margin-top: 2em; margin-bottom: .6em; line-height: 1.3; }
#content h1 {
  font-size: 29px; font-weight: 800;
  background: linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-top: 2.5em;
}
#content h1:first-child { margin-top: 0; }
#content h2 { font-size: 20px; font-weight: 700; color: var(--text); border-left: 4px solid var(--accent); padding-left: 11px; }
#content h3 { font-size: 16px; font-weight: 600; color: var(--accent2); }
#content h4 { font-size: 14px; color: var(--gold); }
#content p { line-height: 1.8; margin-bottom: 1em; color: var(--text); font-size: 15px; }
#content a { color: var(--accent2); text-decoration: none; }
#content a:hover { text-decoration: underline; }
#content strong { color: var(--gold); font-weight: 700; }
#content em { color: var(--accent2); font-style: italic; }
#content ul,#content ol { margin: .5em 0 1em 1.4em; line-height: 1.9; }
#content li { margin-bottom: 3px; font-size: 15px; }
#content li::marker { color: var(--accent); }
#content blockquote {
  border-left: 4px solid var(--accent); background: var(--bg3);
  padding: 11px 16px; border-radius: 0 8px 8px 0;
  margin: 1em 0; color: var(--text2); font-style: italic;
}
#content hr { border: none; border-top: 1px solid var(--border); margin: 2.5em 0; }

/* â”€â”€ TABLES â”€â”€ */
#content table { width:100%; border-collapse:collapse; margin:1.2em 0; font-size:14px; border-radius:var(--r); overflow:hidden; border:1px solid var(--border); }
#content thead th { background:var(--bg4); color:var(--accent); padding:10px 13px; text-align:left; font-weight:700; border-bottom:1px solid var(--border); }
#content tbody td { padding:9px 13px; border-bottom:1px solid var(--border); color:var(--text); vertical-align:top; }
#content tbody tr:hover td { background:var(--bg3); }
#content tbody tr:last-child td { border-bottom:none; }

/* â”€â”€ CODE â”€â”€ */
#content pre { margin:1em 0 1.3em; border-radius:var(--r); border:1px solid var(--border); overflow:hidden; }
#content pre .code-hdr {
  display:flex; align-items:center; justify-content:space-between;
  padding:7px 13px; background:var(--bg4); border-bottom:1px solid var(--border);
  font-size:11px;
}
#content pre .code-lang { font-weight:700; color:var(--accent); text-transform:uppercase; letter-spacing:.5px; }
#content pre .copy-btn {
  padding:2px 9px; background:var(--bg3); border:1px solid var(--border);
  border-radius:5px; color:var(--text2); font-size:11px; cursor:pointer; transition:all .15s;
}
#content pre .copy-btn:hover { background:var(--accent); color:#fff; border-color:var(--accent); }
#content pre .copy-btn.ok { background:var(--green); border-color:var(--green); color:#fff; }
#content pre code {
  display:block; padding:15px 17px;
  font-family:'Cascadia Code','Fira Code','JetBrains Mono',Consolas,monospace;
  font-size:13px; line-height:1.65; overflow-x:auto; background:var(--code-bg) !important;
}
#content :not(pre)>code {
  background:var(--bg4); color:var(--gold); padding:2px 6px;
  border-radius:5px; font-size:13px;
  font-family:'Cascadia Code','Fira Code',Consolas,monospace;
  border:1px solid var(--border);
}

/* â”€â”€ SEARCH HIGHLIGHT â”€â”€ */
mark.hl { background:rgba(245,197,66,.3); color:var(--gold); border-radius:3px; padding:0 2px; }
mark.hl.cur { background:var(--gold); color:#000; }

/* â”€â”€ TOAST â”€â”€ */
#toast {
  position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(20px);
  background:var(--bg4); border:1px solid var(--border); border-radius:10px;
  padding:9px 18px; font-size:13px; color:var(--text);
  opacity:0; pointer-events:none; z-index:300;
  transition:opacity .25s, transform .25s;
  box-shadow: 0 4px 20px rgba(0,0,0,.4);
}
#toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
#toast.ok { border-color:var(--green); color:var(--green); }
#toast.err { border-color:var(--red); color:var(--red); }

/* â”€â”€ BACK-TOP â”€â”€ */
#back-top {
  position:fixed; bottom:28px; right:28px; width:40px; height:40px;
  background:var(--accent); border:none; border-radius:50%;
  color:#fff; font-size:17px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity .25s,transform .25s;
  box-shadow:0 4px 16px rgba(124,106,247,.4);
}
#back-top.on { opacity:1; pointer-events:auto; }
#back-top:hover { transform:translateY(-3px); }

/* â”€â”€ REFRESH STATUS â”€â”€ */
#refresh-status {
  font-size:11px; color:var(--text3); white-space:nowrap;
  display:none;
}
#refresh-status.on { display:inline; }

/* â”€â”€ LIGHT THEME â”€â”€ */
body.light {
  --bg:#f5f5fa; --bg2:#ffffff; --bg3:#efeff7; --bg4:#e4e4f0;
  --border:#d0d0e8; --text:#1a1a2e; --text2:#4a4a6a; --text3:#8888aa;
  --code-bg:#1e1e2e;
}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }

/* â”€â”€ MOBILE â”€â”€ */
#sb-toggle { display:none; background:var(--bg3); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:16px; padding:5px 10px; cursor:pointer; }
@media(max-width:800px){
  #sidebar { transform:translateX(-100%); }
  #sidebar.open { transform:translateX(0); }
  #main { margin-left:0; padding:24px 16px 60px; }
  #sb-toggle { display:block; }
  #file-badge { display:none!important; }
}
</style>
</head>
<body>

<!-- Topbar -->
<div id="topbar">
  <button id="sb-toggle" onclick="toggleSidebar()">â˜°</button>
  <div class="logo">ğŸ® MD Viewer</div>

  <div id="search-wrap">
    <input id="search" type="text" placeholder="ĞŸĞ¾Ğ¸ÑĞº... (Ctrl+F)"
      oninput="handleSearch(this.value)" onkeydown="searchNav(event)">
    <span id="search-count"></span>
  </div>

  <span id="file-badge"></span>
  <span id="refresh-status">ğŸ”„ Ğ°Ğ²Ñ‚Ğ¾</span>

  <button class="tb-btn" id="open-btn"
    onclick="document.getElementById('file-input').click()">ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
  <input type="file" id="file-input" accept=".md,.txt" onchange="loadFile(this)">

  <button class="tb-btn" id="refresh-btn"
    onclick="toggleAutoRefresh()" title="ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°">ğŸ”„ ĞĞ²Ñ‚Ğ¾</button>

  <button class="tb-btn" id="theme-btn"
    onclick="toggleTheme()" title="Ğ¢ĞµĞ¼Ğ°">ğŸŒ™</button>
</div>

<div id="prog-bar"><div id="prog-fill"></div></div>

<!-- Layout -->
<div id="layout">

  <!-- Sidebar -->
  <nav id="sidebar">
    <div class="sb-tabs">
      <button class="sb-tab active" onclick="showTab('toc',this)">ğŸ“‘ Ğ Ğ°Ğ·Ğ´ĞµĞ»Ñ‹</button>
      <button class="sb-tab" onclick="showTab('history',this)">ğŸ•“ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</button>
    </div>

    <!-- TOC -->
    <div class="sb-panel active" id="toc-panel">
      <div id="toc-list"><div style="padding:16px;font-size:12px;color:var(--text3)">ĞÑ‚ĞºÑ€Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ», Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ</div></div>
    </div>

    <!-- History -->
    <div class="sb-panel" id="history-panel">
      <div id="history-list"></div>
    </div>
  </nav>

  <!-- Main -->
  <main id="main">
    <div id="drop-zone">
      <div class="dz-icon">ğŸ“–</div>
      <h2>ĞÑ‚ĞºÑ€Ğ¾Ğ¹ .md Ñ„Ğ°Ğ¹Ğ»</h2>
      <p>ĞĞ°Ğ¶Ğ¼Ğ¸ <strong>Â«ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒÂ»</strong> Ğ²Ğ²ĞµÑ€Ñ…Ñƒ, Ğ¿ĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸ Ñ„Ğ°Ğ¹Ğ» ÑÑĞ´Ğ° Ğ¸Ğ»Ğ¸ Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ¸Ğ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ»ĞµĞ²Ğ°</p>
      <button id="drop-btn" onclick="document.getElementById('file-input').click()">ğŸ“‚ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»</button>
      <span class="dz-or">â€” Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ¿Ñ€ÑĞ¼Ğ¾ ÑÑĞ´Ğ° â€”</span>
    </div>
    <div id="content"></div>
  </main>
</div>

<button id="back-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">â†‘</button>
<div id="toast"></div>

<script>
// â”€â”€ MARKED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
marked.setOptions({ gfm:true, breaks:true,
  highlight:(code,lang) => {
    try { return lang && hljs.getLanguage(lang) ? hljs.highlight(code,{language:lang}).value : hljs.highlightAuto(code).value; }
    catch(e){ return code; }
  }
});
const renderer = new marked.Renderer();
renderer.code = (code, lang) => {
  const dl = lang || 'text';
  let hi;
  try { hi = lang && hljs.getLanguage(lang) ? hljs.highlight(code,{language:lang}).value : hljs.highlightAuto(code).value; }
  catch(e){ hi = code.replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
  const esc = code.replace(/\\/g,'\\\\').replace(/`/g,'\\`');
  return `<pre><div class="code-hdr"><span class="code-lang">${dl}</span><button class="copy-btn" onclick="copyCode(this,\`${esc}\`)">ğŸ“‹ ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button></div><code class="hljs">${hi}</code></pre>`;
};
renderer.heading = (text, level) => {
  const id = 'h-' + text.replace(/[^\wĞ°-ÑĞ-Ğ¯Ñ‘Ğ\s]/g,'').replace(/\s+/g,'-').toLowerCase().slice(0,60);
  return `<h${level} id="${id}">${text}</h${level}>`;
};
marked.use({ renderer });

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentFile = null;       // File object (Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾-Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ)
let currentText = '';         // Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚
let currentName = '';         // Ğ¸Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°
let autoRefreshTimer = null;
let autoRefreshOn = false;
let lastModified = 0;
const HISTORY_KEY = 'mdviewer_history_v2';
const MAX_HISTORY = 10;
const MAX_CONTENT_SIZE = 800000; // ~800KB Ğ½Ğ° Ñ„Ğ°Ğ¹Ğ» Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸

// â”€â”€ LOAD FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadFile(input) {
  const file = input.files[0];
  if (!file) return;
  currentFile = file;
  lastModified = file.lastModified;
  readAndRender(file, true);
  // Ğ¡Ğ±Ñ€Ğ¾Ñ input Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Ñ„Ğ°Ğ¹Ğ» ÑĞ½Ğ¾Ğ²Ğ°
  input.value = '';
}

function readAndRender(file, addToHistory) {
  const reader = new FileReader();
  reader.onload = e => {
    renderMarkdown(e.target.result, file.name, addToHistory);
  };
  reader.onerror = () => toast('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°', 'err');
  reader.readAsText(file, 'UTF-8');
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkdown(text, filename, addToHistory) {
  currentText = text;
  currentName = filename;

  const content = document.getElementById('content');
  const dropZone = document.getElementById('drop-zone');
  const savedScroll = content.style.display !== 'none' ? window.scrollY : 0;
  const wasLoaded = content.style.display === 'block';

  dropZone.style.display = 'none';
  content.style.display = 'block';
  content.innerHTML = marked.parse(text);

  buildTOC();
  updateBadge(filename, text);

  if (!wasLoaded) {
    window.scrollTo(0, 0);
  }

  if (addToHistory) {
    saveToHistory(filename, text);
    renderHistory();
  }
  clearSearch();
}

// â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBadge(name, text) {
  const b = document.getElementById('file-badge');
  const lines = text.split('\n').length;
  const mins = Math.ceil(text.split(/\s+/).length / 200);
  b.textContent = `${name}  â€¢  ${lines.toLocaleString()} ÑÑ‚Ñ€Ğ¾Ğº  â€¢  ~${mins} Ğ¼Ğ¸Ğ½`;
  b.style.display = 'inline-block';
  document.title = name + ' â€” MD Viewer';
}

// â”€â”€ TOC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTOC() {
  const list = document.getElementById('toc-list');
  list.innerHTML = '';
  const hs = document.querySelectorAll('#content h1,#content h2,#content h3');
  if (!hs.length) {
    list.innerHTML = '<div style="padding:12px 14px;font-size:12px;color:var(--text3)">Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹</div>';
    return;
  }
  hs.forEach(h => {
    const a = document.createElement('a');
    a.className = 'toc-item ' + h.tagName.toLowerCase();
    a.textContent = h.textContent;
    a.title = h.textContent;
    a.href = '#';
    a.onclick = e => {
      e.preventDefault();
      h.scrollIntoView({ behavior:'smooth', block:'start' });
      setActiveTOC(a);
    };
    list.appendChild(a);
  });
  setupScrollSpy();
}

function setActiveTOC(el) {
  document.querySelectorAll('.toc-item').forEach(i => i.classList.remove('active'));
  if (el) el.classList.add('active');
}

// â”€â”€ SCROLL SPY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let spyTimer;
function setupScrollSpy() {
  window.removeEventListener('scroll', onScroll);
  window.addEventListener('scroll', onScroll);
}
function onScroll() {
  clearTimeout(spyTimer);
  spyTimer = setTimeout(doScrollSpy, 80);
  updateProg();
  updateBackTop();
}
function doScrollSpy() {
  const hs = document.querySelectorAll('#content h1,#content h2,#content h3');
  let active = null;
  hs.forEach(h => { if (h.getBoundingClientRect().top <= 80) active = h; });
  if (!active) { setActiveTOC(null); return; }
  const links = document.querySelectorAll('#toc-list .toc-item');
  links.forEach(a => {
    if (a.textContent === active.textContent) {
      setActiveTOC(a);
      a.scrollIntoView({ block:'nearest', behavior:'smooth' });
    }
  });
}

// â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateProg() {
  const pct = document.documentElement.scrollHeight - window.innerHeight;
  document.getElementById('prog-fill').style.width = (pct > 0 ? window.scrollY/pct*100 : 0) + '%';
}
function updateBackTop() {
  document.getElementById('back-top').classList.toggle('on', window.scrollY > 400);
}

// â”€â”€ COPY CODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyCode(btn, code) {
  navigator.clipboard.writeText(code).then(() => {
    btn.textContent = 'âœ… Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾';
    btn.classList.add('ok');
    setTimeout(() => { btn.textContent = 'ğŸ“‹ ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ'; btn.classList.remove('ok'); }, 2000);
  }).catch(() => toast('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ', 'err'));
}

// â”€â”€ AUTO REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAutoRefresh() {
  if (!currentFile) {
    toast('Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ»', 'err');
    return;
  }
  autoRefreshOn = !autoRefreshOn;
  const btn = document.getElementById('refresh-btn');
  const status = document.getElementById('refresh-status');

  if (autoRefreshOn) {
    btn.classList.add('active');
    btn.textContent = 'â¸ Ğ¡Ñ‚Ğ¾Ğ¿';
    status.classList.add('on');
    startAutoRefresh();
    toast('ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ (ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 3 ÑĞµĞº)', 'ok');
  } else {
    btn.classList.remove('active');
    btn.textContent = 'ğŸ”„ ĞĞ²Ñ‚Ğ¾';
    status.classList.remove('on');
    stopAutoRefresh();
    toast('ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾');
  }
}

function startAutoRefresh() {
  stopAutoRefresh();
  autoRefreshTimer = setInterval(() => {
    if (!currentFile || !autoRefreshOn) return;
    // ĞŸĞµÑ€ĞµÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» (Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ±ĞµÑ€Ñ‘Ñ‚ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ)
    const reader = new FileReader();
    reader.onload = e => {
      const newText = e.target.result;
      if (newText !== currentText) {
        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ ÑĞºÑ€Ğ¾Ğ»Ğ»Ğ°
        const scrollPos = window.scrollY;
        renderMarkdown(newText, currentName, false);
        // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
        window.scrollTo(0, scrollPos);
        toast('ğŸ“„ Ğ¤Ğ°Ğ¹Ğ» Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½');
      }
    };
    reader.readAsText(currentFile, 'UTF-8');
  }, 3000);
}

function stopAutoRefresh() {
  if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getHistory() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }
  catch(e) { return []; }
}

function saveToHistory(name, text) {
  let hist = getHistory();
  // Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ñ Ñ‚ĞµĞ¼ Ğ¶Ğµ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼
  hist = hist.filter(h => h.name !== name);
  // ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾
  const entry = {
    name,
    date: Date.now(),
    lines: text.split('\n').length,
    // Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹
    content: text.length <= MAX_CONTENT_SIZE ? text : null,
    truncated: text.length > MAX_CONTENT_SIZE,
  };
  hist.unshift(entry);
  // Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
  hist = hist.slice(0, MAX_HISTORY);
  try { localStorage.setItem(HISTORY_KEY, JSON.stringify(hist)); }
  catch(e) {
    // Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ Ğ¼ĞµÑÑ‚Ğ° â€” ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ñƒ ÑÑ‚Ğ°Ñ€Ñ‹Ñ…
    hist.forEach((h, i) => { if (i > 2) h.content = null; });
    try { localStorage.setItem(HISTORY_KEY, JSON.stringify(hist)); } catch(e2) {}
  }
}

function renderHistory() {
  const container = document.getElementById('history-list');
  const hist = getHistory();

  if (!hist.length) {
    container.innerHTML = '<div class="hist-empty">ğŸ“‚<br>Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿ÑƒÑÑ‚Ğ°.<br>ĞÑ‚ĞºÑ€Ğ¾Ğ¹ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² â€” Ğ¾Ğ½Ğ¸ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ.</div>';
    return;
  }

  const frag = document.createDocumentFragment();

  hist.forEach((entry, idx) => {
    const item = document.createElement('div');
    item.className = 'hist-item' + (entry.name === currentName ? ' current-doc' : '');

    const age = formatAge(entry.date);
    const sizeStr = entry.content
      ? `${entry.lines.toLocaleString()} ÑÑ‚Ñ€Ğ¾Ğº`
      : `${entry.lines.toLocaleString()} ÑÑ‚Ñ€Ğ¾Ğº (Ğ½ĞµÑ‚ Ğ² ĞºĞµÑˆĞµ)`;

    item.innerHTML = `
      <div class="hist-icon">ğŸ“„</div>
      <div class="hist-info">
        <div class="hist-name" title="${entry.name}">${entry.name}</div>
        <div class="hist-meta">${age} Â· ${sizeStr}</div>
      </div>
      <button class="hist-del" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸" onclick="deleteHistory(event,${idx})">âœ•</button>
    `;

    item.addEventListener('click', () => openFromHistory(entry));
    frag.appendChild(item);
  });

  // ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸
  const clearBtn = document.createElement('button');
  clearBtn.className = 'hist-clear-btn';
  clearBtn.textContent = 'ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ';
  clearBtn.onclick = () => {
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
    toast('Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ°');
  };
  frag.appendChild(clearBtn);

  container.innerHTML = '';
  container.appendChild(frag);
}

function openFromHistory(entry) {
  if (entry.content) {
    // Ğ•ÑÑ‚ÑŒ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ â€” Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ€Ğ°Ğ·Ñƒ
    currentName = entry.name;
    currentFile = null;  // Ğ½ĞµÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ° File
    renderMarkdown(entry.content, entry.name, false);
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
    saveToHistory(entry.name, entry.content);
    renderHistory();
    toast('ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¾ Ğ¸Ğ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸: ' + entry.name, 'ok');
    if (autoRefreshOn) {
      stopAutoRefresh();
      autoRefreshOn = false;
      document.getElementById('refresh-btn').classList.remove('active');
      document.getElementById('refresh-btn').textContent = 'ğŸ”„ ĞĞ²Ñ‚Ğ¾';
      document.getElementById('refresh-status').classList.remove('on');
      toast('ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ (Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ)', 'err');
    }
  } else {
    // ĞĞµÑ‚ ĞºĞµÑˆĞ° â€” Ğ¿Ñ€Ğ¾ÑĞ¸Ğ¼ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»
    toast('Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ² ĞºĞµÑˆĞµ â€” Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ¹ ĞµĞ³Ğ¾ Ñ‡ĞµÑ€ĞµĞ· ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒÂ»', 'err');
    showTab('toc', document.querySelector('.sb-tab'));
  }
}

function deleteHistory(e, idx) {
  e.stopPropagation();
  const hist = getHistory();
  hist.splice(idx, 1);
  try { localStorage.setItem(HISTORY_KEY, JSON.stringify(hist)); } catch(e2){}
  renderHistory();
}

function formatAge(ts) {
  const diff = Date.now() - ts;
  const m = Math.floor(diff / 60000);
  const h = Math.floor(diff / 3600000);
  const d = Math.floor(diff / 86400000);
  if (m < 1) return 'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾';
  if (m < 60) return m + ' Ğ¼Ğ¸Ğ½ Ğ½Ğ°Ğ·Ğ°Ğ´';
  if (h < 24) return h + ' Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´';
  if (d < 7) return d + ' Ğ´Ğ½ Ğ½Ğ°Ğ·Ğ°Ğ´';
  return new Date(ts).toLocaleDateString('ru');
}

// â”€â”€ SIDEBAR TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(name, btn) {
  document.querySelectorAll('.sb-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.sb-panel').forEach(p => p.classList.remove('active'));
  if (btn) btn.classList.add('active');
  else {
    document.querySelectorAll('.sb-tab').forEach(t => {
      if (t.textContent.toLowerCase().includes(name === 'toc' ? 'Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ñ‹' : 'Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ'))
        t.classList.add('active');
    });
  }
  document.getElementById(name === 'toc' ? 'toc-panel' : 'history-panel').classList.add('active');
}

// â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let searchMatches = [], searchIdx = 0, searchTimer;

function handleSearch(q) {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => doSearch(q), 180);
}

function doSearch(q) {
  const cnt = document.getElementById('content');
  const countEl = document.getElementById('search-count');
  cnt.querySelectorAll('mark.hl').forEach(m => m.replaceWith(document.createTextNode(m.textContent)));
  cnt.normalize();
  searchMatches = []; searchIdx = 0;
  if (!q.trim() || q.length < 2) { countEl.textContent = ''; return; }

  const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi');
  const walk = node => {
    if (node.nodeType === 3) {
      const t = node.textContent;
      if (!re.test(t)) return; re.lastIndex = 0;
      const frag = document.createDocumentFragment();
      let last = 0, m;
      while ((m = re.exec(t)) !== null) {
        frag.appendChild(document.createTextNode(t.slice(last, m.index)));
        const mark = document.createElement('mark');
        mark.className = 'hl'; mark.textContent = m[0];
        frag.appendChild(mark); searchMatches.push(mark); last = re.lastIndex;
      }
      frag.appendChild(document.createTextNode(t.slice(last)));
      node.replaceWith(frag);
    } else if (node.nodeType === 1 && !['CODE','PRE','SCRIPT','STYLE'].includes(node.tagName)) {
      [...node.childNodes].forEach(walk);
    }
  };
  walk(cnt);

  if (searchMatches.length) {
    searchMatches[0].classList.add('cur');
    searchMatches[0].scrollIntoView({ behavior:'smooth', block:'center' });
    countEl.textContent = `1 / ${searchMatches.length}`;
  } else { countEl.textContent = 'ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾'; }
}

function searchNav(e) {
  if (!searchMatches.length) return;
  if (e.key === 'Enter') {
    searchMatches[searchIdx].classList.remove('cur');
    searchIdx = e.shiftKey ? (searchIdx-1+searchMatches.length)%searchMatches.length : (searchIdx+1)%searchMatches.length;
    searchMatches[searchIdx].classList.add('cur');
    searchMatches[searchIdx].scrollIntoView({ behavior:'smooth', block:'center' });
    document.getElementById('search-count').textContent = `${searchIdx+1} / ${searchMatches.length}`;
  }
  if (e.key === 'Escape') { document.getElementById('search').value=''; doSearch(''); }
}

function clearSearch() {
  document.getElementById('search').value = '';
  document.getElementById('search-count').textContent = '';
  searchMatches = [];
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function toast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.className = '', 2800);
}

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let isLight = false;
function toggleTheme() {
  isLight = !isLight;
  document.body.classList.toggle('light', isLight);
  document.getElementById('theme-btn').textContent = isLight ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('mdv_theme', isLight ? 'light' : 'dark');
}
if (localStorage.getItem('mdv_theme') === 'light') toggleTheme();

// â”€â”€ SIDEBAR TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dz = document.getElementById('drop-zone');
document.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
document.addEventListener('dragleave', e => { if (!e.relatedTarget) dz.classList.remove('drag-over'); });
document.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && (file.name.endsWith('.md') || file.name.endsWith('.txt'))) {
    currentFile = file;
    readAndRender(file, true);
  } else if (file) {
    toast('ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ .md Ğ¸ .txt Ñ„Ğ°Ğ¹Ğ»Ñ‹', 'err');
  }
});

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  if ((e.ctrlKey||e.metaKey) && e.key==='f') { e.preventDefault(); document.getElementById('search').focus(); }
  if ((e.ctrlKey||e.metaKey) && e.key==='o') { e.preventDefault(); document.getElementById('file-input').click(); }
  if ((e.ctrlKey||e.metaKey) && e.key==='r' && currentFile) { e.preventDefault(); readAndRender(currentFile, false); toast('ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾', 'ok'); }
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderHistory();
</script>
</body>
</html>
